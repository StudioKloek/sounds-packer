"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("ora"),t=require("fs-extra"),a=require("get-value"),r=require("object.defaults"),o=require("path"),n=require("log-symbols"),s=require("chalk"),i=require("set-value"),c=require("pupa"),u=require("uppercamelcase"),l=require("camelcase"),f=require("get-audio-duration"),d=require("globby"),p=require("hasha"),g=require("sane"),y=require("throttle-debounce");function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=h(e),w=h(t),$=h(a),b=h(r),D=h(o),j=h(n),q=h(s),v=h(i),k=h(c),O=h(u),N=h(l),S=h(d),x=h(p);function A(e,t){let a=(e=`${e}`).replace(`${t}/`,"").split("/").map((e=>{return/^\d/.test(t=e)&&(t=`s${t}`),t.replace(/(\W)/g,"_").replace(/_{2,}/g,".").replace(/^_/,"").replace(/_$/,"");var t})),r=a.pop();r=r.toUpperCase(),a=a.map((e=>N.default(e)));let o=t.split("/");return o=o.slice(o.length-(1===o.length?1:2)),o.push("sounds"),o=O.default(o.join("-")),a.length>0?[o,e=(e=a.join(".")).replace(/(\W^\.)/g,"").replace(/\.{2,}/g,".").replace(/^\./,"").replace(/\.$/,""),r].join("."):[o,r].join(".")}function C(e){const t=[];for(const a of Object.keys(e))e.hasOwnProperty(a)&&t.push([a,e[a]]);t.sort(((e,t)=>{const a=e[0],r=t[0];return a<r?-1:a>r?1:0}));const a={};for(const e of t)a[e[0]]=e[1];return a}async function _(e,t,a,r){const o=$.default(r,"scriptDirectory",a.scriptDirectory),n=function(e,t){let a="";const r=[];for(const t of Object.keys(e)){const o=C(e[t]);let n=JSON.stringify(o,void 0,2);n=n.replace(/"([^"()]+)":/g,"$1:"),a=`${a}${k.default("export const {assetName} = {assetData};",{assetName:t,assetData:n})}\n`,r.push(t)}return a=`${a}${k.default("export default {\n  assetName : '{assetName}',\n  assets : {assets},\n  numberOfSounds : {numberOfSounds},\n  type: 'sounds'\n};",{assets:r,assetName:t.fileName,numberOfSounds:t.numberOfSounds})}\n`,a}(function(e,t){const a=t,r={};for(const t of e||[]){const e={id:t.hash,duration:t.duration,name:t.name};v.default(r,A(D.default.join(t.path,t.name),a),e)}return r}(t,e),{fileName:e,numberOfSounds:t.length}),s=function(e,t){const a=e.split("/"),r=a.pop();return a.length<2&&a.push(r),e=a.join("/"),`${D.default.join(t,e)}/assets/sounds-${r}.ts`}(e,o);await w.default.outputFile(s,n)}const F={},P={};async function G(e,t){let a,r;if(Array.isArray(e)?(a=e[0],r=e[1]):a=e,F[a])return console.log(j.default.warning,q.default.yellow("Allready packing, starting again afterwards...")),void(P[a]=!0);F[a]=!0;const o=m.default(`Packing ${a}`).start();try{if(!async function(e,t,a){const r=D.default.join(t.sourceDirectory,e),o=await S.default(`${r}/**/*.wav`),n=[];for(const e of o){let a=await x.default.fromFile(e,{algorithm:"md5"});a=a.slice(0,10);let o=await f.getAudioDurationInSeconds(e);o=Math.round(1e4*o)/1e4;const s=e.replace(`${r}/`,""),i={filename:D.default.basename(s,".wav"),path:s.replace(`${D.default.basename(s)}`,""),duration:o,hash:a};let c=i.filename;for(const e of t.prefixes)c.startsWith(e)&&(c=c.slice(e.length));i.name=c,n.push(i)}if(!await async function(e,t,a,r){if(!0===$.default(r,"onlyGenerateCode",a.onlyGenerateCode))return!0;const o=D.default.join(a.sourceDirectory,e);for(const e of t)try{for(const t of a.formats)await w.default.copy(`${D.default.join(o,e.path,e.filename)}.${t}`,`${D.default.join(a.targetDirectory,e.hash)}.${t}`)}catch(e){return console.log(e),!1}return!0}(e,n,t,a))return!1;return await _(e,n,t,a),!0}(a,t,r))return void o.fail(`Error packing ${a}`)}catch(e){return o.fail(`Error packing ${a}`),void console.error(j.default.warning,e.message)}F[a]=!1,P[a]?(P[a]=!1,o.warn("Needs repacking, something changed while packing..."),await G(e,t)):o.succeed(`Done packing ${a}`)}async function W(e,t){return new Promise((a=>{let r,o={};if(Array.isArray(e)?(r=e[0],o=e[1]):r=e,!0!==t.watch&&!0!==o.watch||!1===o.watch)return void a();const n=y.debounce(t.watchDelay,(()=>{G(e,t)})),s=g.sane(`${D.default.join(t.sourceDirectory,r)}`,{glob:["**/*.png","**/*.jpg"]});s.on("ready",(()=>{console.log(j.default.info,q.default.blue(`Started watching ${r} with a delay of ${t.watchDelay/1e3}s`)),a()})),s.on("change",n),s.on("add",n),s.on("delete",n)}))}async function E(e){const t=await async function(e){const t=m.default(`Reading settings from ${e}...`).start();let a={};try{const t=await w.default.readJSON(e);a=$.default(t,"sounds",{}),a=b.default(a,{sourceDirectory:"./assets/",scriptDirectory:"./assets/converted/",targetDirectory:"./assets/converted/",watch:!1,watchDelay:500,onlyGenerateCode:!1,prefixes:[],formats:["ogg","mp3"],directories:[]}),a.prefixes.sort(((e,t)=>e<t?1:e>t?-1:0))}catch(r){return console.log(r),t.fail(`Could not load settings from ${e}... (does it exist?)`),a}const r=a.directories.length;return r?t.succeed(`Found ${r} directories to process...`):t.fail("Found no directories to process..."),a}(e),a=t.directories;delete t.directories,t&&a&&(await async function(e,t){console.log(j.default.info,q.default.blue("Start packing all items...")),console.log(j.default.info,q.default.blue(`Clearing sounds directory (${t.targetDirectory})...`)),await w.default.emptyDir(t.targetDirectory);for(const a of e)await G(a,t);console.log(j.default.success,q.default.green("Done packing all items..."))}(a,t),await async function(e,t){for(const a of e)await W(a,t)}(a,t))}exports.pack=function(e){E(e||"assets.json")};
